<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRE Powered Self-Healing Reserve | Live Dashboard</title>
  <meta name="description" content="Confidential proof-of-reserve with autonomous recovery. Built on Chainlink CRE for Convergence Hackathon 2026.">
  <meta property="og:title" content="CRE Powered Self-Healing Reserve">
  <meta property="og:description" content="When a reserve drops below 100%, the fix shouldn't cause a panic. Confidential verification + autonomous recovery powered by Chainlink CRE.">
  <meta property="og:url" content="https://self-healing-reserve.vercel.app">
  <meta property="og:type" content="website">
  <meta property="og:image" content="https://self-healing-reserve.vercel.app/og-image.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://self-healing-reserve.vercel.app/og-image.png">
  <meta name="twitter:title" content="CRE Powered Self-Healing Reserve">
  <meta name="twitter:description" content="Confidential proof-of-reserve with autonomous recovery. Built on Chainlink CRE for Convergence Hackathon 2026.">
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: #0a0a0f;
      color: #e0e0e0;
      font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
      min-height: 100vh;
      padding: 24px;
    }

    h1 {
      text-align: center;
      font-size: 1.5rem;
      color: #8b8bff;
      margin-bottom: 8px;
      letter-spacing: 1px;
    }

    .subtitle {
      text-align: center;
      color: #666;
      font-size: 0.8rem;
      margin-bottom: 8px;
    }

    .description {
      max-width: 720px;
      margin: 0 auto 28px;
      text-align: center;
      color: #999;
      font-size: 0.85rem;
      line-height: 1.6;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    /* Architecture flow */
    .arch-flow {
      display: flex;
      align-items: flex-start;
      justify-content: center;
      gap: 0;
      max-width: 1000px;
      margin: 0 auto 32px;
    }

    .arch-step {
      flex: 1;
      text-align: center;
      padding: 16px 10px;
      background: #12121a;
      border: 1px solid #222;
      border-radius: 8px;
      min-width: 0;
    }

    .arch-step-num {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: #8b8bff;
      color: #000;
      font-size: 0.75rem;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 8px;
    }

    .arch-label {
      font-size: 0.78rem;
      color: #e0e0e0;
      font-weight: bold;
      margin-bottom: 4px;
    }

    .arch-desc {
      font-size: 0.68rem;
      color: #666;
      line-height: 1.4;
    }

    .arch-arrow {
      display: flex;
      align-items: center;
      padding: 0 6px;
      color: #8b8bff;
      font-size: 1.2rem;
      margin-top: 20px;
      flex-shrink: 0;
    }

    /* Demo controls */
    .demo-controls {
      max-width: 1000px;
      margin: 0 auto 24px;
      background: #12121a;
      border: 1px solid #222;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
    }

    .demo-controls h2 {
      font-size: 1.3rem;
      color: #e0e0e0;
      text-transform: uppercase;
      letter-spacing: 3px;
      margin-bottom: 12px;
    }

    .demo-desc {
      color: #666;
      font-size: 0.8rem;
      margin-bottom: 16px;
    }

    .demo-btn-group {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .btn-primary {
      background: #22c55e !important;
      color: #000 !important;
      font-weight: bold;
      border-color: #22c55e !important;
      padding: 10px 24px !important;
      font-size: 0.85rem !important;
    }

    .btn-primary:hover {
      background: #16a34a !important;
      border-color: #16a34a !important;
    }

    .btn-danger-outline {
      background: transparent !important;
      color: #ef4444 !important;
      font-weight: bold;
      border-color: #ef4444 !important;
      padding: 10px 24px !important;
      font-size: 0.85rem !important;
    }

    .btn-danger-outline:hover {
      background: #ef4444 !important;
      color: #fff !important;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      max-width: 1000px;
      margin: 0 auto;
    }

    .card {
      background: #12121a;
      border: 1px solid #222;
      border-radius: 8px;
      padding: 20px;
    }

    .card h2 {
      font-size: 0.85rem;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 16px;
    }

    .card.full-width {
      grid-column: 1 / -1;
    }

    /* Status indicator */
    .status-block {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .status-dot {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      flex-shrink: 0;
      animation: pulse 2s ease-in-out infinite;
    }

    .status-dot.solvent {
      background: #22c55e;
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.4);
    }

    .status-dot.insolvent {
      background: #ef4444;
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .status-label {
      font-size: 1.4rem;
      font-weight: bold;
    }

    .status-label.solvent { color: #22c55e; }
    .status-label.insolvent { color: #ef4444; }

    /* Stats */
    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #1a1a25;
    }

    .stat-row:last-child { border-bottom: none; }

    .stat-label { color: #888; }
    .stat-value { color: #e0e0e0; font-weight: bold; }

    /* Ratio bar */
    .ratio-bar-container {
      margin-top: 12px;
    }

    .ratio-bar-track {
      height: 8px;
      background: #1a1a25;
      border-radius: 4px;
      overflow: visible;
      margin-top: 6px;
      position: relative;
    }

    .ratio-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease, background 0.5s ease;
    }

    .ratio-bar-fill.healthy { background: #22c55e; }
    .ratio-bar-fill.warning { background: #eab308; }
    .ratio-bar-fill.danger { background: #ef4444; }

    .ratio-threshold {
      position: absolute;
      left: 50%;
      top: -6px;
      bottom: -6px;
      width: 2px;
      background: #8b8bff;
      opacity: 0.6;
    }

    .ratio-threshold-label {
      position: absolute;
      bottom: -18px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.6rem;
      color: #8b8bff;
      white-space: nowrap;
      opacity: 0.7;
    }

    .ratio-label {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: #666;
    }

    /* Event timeline */
    .timeline {
      max-height: 260px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #333 #12121a;
    }

    .event-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid #1a1a25;
      font-size: 0.85rem;
      transition: background 0.3s ease;
    }

    .event-item:last-child { border-bottom: none; }

    .event-item.new-event {
      animation: flash-highlight 2s ease-out;
    }

    @keyframes flash-highlight {
      0% { background: rgba(139, 139, 255, 0.3); }
      100% { background: transparent; }
    }

    .event-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .event-dot.solvent { background: #22c55e; }
    .event-dot.insolvent { background: #ef4444; }

    .event-time { color: #666; font-size: 0.8rem; min-width: 80px; }
    .event-block { color: #555; font-size: 0.75rem; }

    .empty-state {
      color: #444;
      font-style: italic;
      padding: 20px 0;
      text-align: center;
    }

    /* Agent activity */
    .activity-item {
      padding: 8px 0;
      border-bottom: 1px solid #1a1a25;
      font-size: 0.85rem;
    }

    .activity-item:last-child { border-bottom: none; }

    .activity-action {
      color: #eab308;
      font-weight: bold;
      text-transform: uppercase;
      font-size: 0.75rem;
    }

    .activity-details { color: #999; margin-top: 2px; }
    .activity-time { color: #555; font-size: 0.75rem; }


    /* Metrics */
    .metrics-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .metric-box {
      background: #1a1a25;
      padding: 12px;
      border-radius: 6px;
    }

    .metric-label {
      font-size: 0.75rem;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .metric-value {
      font-size: 1.5rem;
      font-weight: bold;
      margin-top: 4px;
    }

    .metric-value.success { color: #22c55e; }
    .metric-value.warning { color: #eab308; }
    .metric-value.danger { color: #ef4444; }
    .metric-value.neutral { color: #e0e0e0; }

    /* Recovery steps */
    .recovery-step {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px;
      background: #1a1a25;
      border-radius: 6px;
      margin-bottom: 8px;
    }

    .step-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 0.75rem;
      font-weight: bold;
    }

    .step-icon.success {
      background: #22c55e;
      color: #000;
    }

    .step-icon.failure {
      background: #ef4444;
      color: #fff;
    }

    .step-icon.pending {
      background: #444;
      color: #888;
    }

    .step-info { flex: 1; }
    .step-name { font-size: 0.85rem; color: #e0e0e0; }
    .step-desc { font-size: 0.7rem; color: #666; margin-top: 2px; }
    .step-data { font-size: 0.72rem; color: #999; margin-top: 3px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    .step-duration { font-size: 0.75rem; color: #666; }

    .mechanism-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 0.65rem;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .mechanism-badge.direct {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .mechanism-badge.darkpool {
      background: rgba(139, 139, 255, 0.15);
      color: #8b8bff;
      border: 1px solid rgba(139, 139, 255, 0.3);
    }

    .btn-darkpool {
      background: #8b8bff !important;
      color: #000 !important;
      font-weight: bold;
      border-color: #8b8bff !important;
      padding: 10px 24px !important;
      font-size: 0.85rem !important;
    }

    .btn-darkpool:hover {
      background: #7070ff !important;
      border-color: #7070ff !important;
    }

    .recovery-summary {
      padding: 12px 16px;
      border-radius: 6px;
      font-size: 0.82rem;
      line-height: 1.6;
      margin-bottom: 14px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .recovery-summary strong { font-weight: 700; }

    .recovery-summary-success {
      background: rgba(34, 197, 94, 0.08);
      border: 1px solid rgba(34, 197, 94, 0.25);
      color: #bbf7d0;
    }

    .recovery-summary-failure {
      background: rgba(239, 68, 68, 0.08);
      border: 1px solid rgba(239, 68, 68, 0.25);
      color: #fecaca;
    }

    /* Buttons */
    .btn-group {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .btn {
      padding: 6px 12px;
      font-size: 0.75rem;
      background: #1a1a25;
      color: #888;
      border: 1px solid #333;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
      text-decoration: none;
      display: inline-block;
    }

    .btn:hover {
      background: #222;
      color: #e0e0e0;
      border-color: #555;
    }

    /* Alerts */
    .alert-providers {
      display: flex;
      gap: 12px;
      margin-top: 12px;
    }

    .provider-badge {
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 0.75rem;
      background: #1a1a25;
    }

    .provider-badge.enabled { color: #22c55e; }
    .provider-badge.disabled { color: #666; }

    .alert-item {
      padding: 10px;
      background: #1a1a25;
      border-left: 3px solid #ef4444;
      border-radius: 4px;
      margin-bottom: 8px;
      font-size: 0.85rem;
    }

    .alert-type {
      font-weight: bold;
      color: #ef4444;
      font-size: 0.75rem;
      text-transform: uppercase;
    }

    .alert-message { color: #e0e0e0; margin: 4px 0; }
    .alert-time { color: #666; font-size: 0.75rem; }

    /* Expandable sections */
    .expandable {
      cursor: pointer;
      user-select: none;
    }

    .expandable:hover { color: #8b8bff; }

    .expanded-content {
      margin-top: 12px;
      max-height: 200px;
      overflow-y: auto;
    }

    /* Toast notifications */
    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 1000;
      display: flex;
      flex-direction: column-reverse;
      gap: 8px;
    }

    .toast {
      padding: 14px 20px;
      border-radius: 8px;
      font-size: 0.82rem;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      line-height: 1.5;
      max-width: 360px;
      transform: translateX(120%);
      opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }

    .toast.show {
      transform: translateX(0);
      opacity: 1;
    }

    .toast-success {
      background: #14532d;
      border: 1px solid #22c55e;
      color: #bbf7d0;
    }

    .toast-error {
      background: #450a0a;
      border: 1px solid #ef4444;
      color: #fecaca;
    }

    .toast-info {
      background: #1e1b4b;
      border: 1px solid #8b8bff;
      color: #c7d2fe;
    }

    .toast-title {
      font-weight: bold;
      margin-bottom: 4px;
    }

    /* Recovery Tabs */
    .recovery-tabs {
      max-width: 1000px;
      margin: 0 auto 28px;
      background: #12121a;
      border: 1px solid #222;
      border-radius: 12px;
      overflow: hidden;
    }

    .recovery-tab-nav {
      display: flex;
      border-bottom: 1px solid #222;
      background: #0e0e16;
    }

    .recovery-tab-btn {
      flex: 1;
      padding: 14px 16px;
      font-size: 0.75rem;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: #555;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }

    .recovery-tab-btn:hover {
      color: #888;
      background: rgba(139, 139, 255, 0.03);
    }

    .recovery-tab-btn.active {
      color: #8b8bff;
      border-bottom-color: #8b8bff;
    }

    .recovery-tab-btn[data-tab="direct"].active {
      color: #3b82f6;
      border-bottom-color: #3b82f6;
    }

    .recovery-tab-btn[data-tab="darkpool"].active {
      color: #8b8bff;
      border-bottom-color: #8b8bff;
    }

    .recovery-tab-content {
      display: none;
      padding: 28px;
      min-height: 420px;
    }

    .recovery-tab-content.active {
      display: block;
    }

    /* Cover tab */
    .tab-cover-intro {
      text-align: center;
      padding: 20px 0;
    }

    .tab-cover-intro h2 {
      font-size: 0.95rem;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 12px;
    }

    .tab-cover-intro p {
      color: #666;
      font-size: 0.82rem;
      line-height: 1.6;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 600px;
      margin: 0 auto 24px;
    }

    .tab-cover-cta {
      color: #555;
      font-size: 0.75rem;
      font-style: italic;
      margin-top: 16px;
    }

    .recovery-tab-btn[data-tab="failure"].active {
      color: #ef4444;
      border-bottom-color: #ef4444;
    }

    .failure-explainer {
      position: relative;
      overflow: hidden;
    }

    .failure-explainer::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, #ef4444, transparent);
    }

    .failure-explainer h2 {
      font-size: 0.95rem;
      color: #ef4444;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 6px;
    }

    .failure-explainer .fail-subtitle {
      color: #666;
      font-size: 0.8rem;
      margin-bottom: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .fail-why {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 24px;
    }

    .fail-why-what, .fail-why-next {
      padding: 16px;
      border-radius: 8px;
      font-size: 0.82rem;
      line-height: 1.6;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .fail-why-what {
      background: rgba(239, 68, 68, 0.06);
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .fail-why-what h3 {
      color: #ef4444;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .fail-why-what ul { list-style: none; padding: 0; }
    .fail-why-what li { color: #999; padding: 3px 0; }
    .fail-why-what li::before { content: '\2717 '; color: #ef4444; }

    .fail-why-next {
      background: rgba(234, 179, 8, 0.06);
      border: 1px solid rgba(234, 179, 8, 0.2);
    }

    .fail-why-next h3 {
      color: #eab308;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .fail-why-next ul { list-style: none; padding: 0; }
    .fail-why-next li { color: #aaa; padding: 3px 0; }
    .fail-why-next li::before { content: '\25B8 '; color: #eab308; }

    /* Direct Swap Explainer */
    .directswap-explainer {
      position: relative;
      overflow: hidden;
    }

    .directswap-explainer::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, #3b82f6, transparent);
    }

    .directswap-explainer h2 {
      font-size: 0.95rem;
      color: #3b82f6;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 6px;
    }

    .directswap-explainer .ds-subtitle {
      color: #666;
      font-size: 0.8rem;
      margin-bottom: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .ds-why {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 24px;
    }

    .ds-why-when, .ds-why-how {
      padding: 16px;
      border-radius: 8px;
      font-size: 0.82rem;
      line-height: 1.6;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .ds-why-when {
      background: rgba(59, 130, 246, 0.06);
      border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .ds-why-when h3 {
      color: #3b82f6;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .ds-why-how {
      background: rgba(34, 197, 94, 0.06);
      border: 1px solid rgba(34, 197, 94, 0.2);
    }

    .ds-why-how h3 {
      color: #22c55e;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .ds-why-when ul, .ds-why-how ul { list-style: none; padding: 0; margin: 0; }
    .ds-why-when li, .ds-why-how li { padding: 4px 0; color: #aaa; }
    .ds-why-when li::before { content: '\25B8 '; color: #3b82f6; }
    .ds-why-how li::before { content: '\2713 '; color: #22c55e; }

    .ds-flow {
      display: grid;
      grid-template-columns: 1fr auto 1fr auto 1fr;
      gap: 8px;
      align-items: center;
    }

    .ds-flow-step {
      background: #1a1a28;
      border: 1px solid #2a2a40;
      border-radius: 10px;
      padding: 16px 12px;
      text-align: center;
    }

    .ds-flow-icon { font-size: 1.5rem; margin-bottom: 6px; }
    .ds-flow-label { font-size: 0.78rem; font-weight: 700; color: #e0e0e0; margin-bottom: 4px; }
    .ds-flow-desc { font-size: 0.7rem; color: #888; line-height: 1.4; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }

    .ds-flow-privacy {
      display: inline-block;
      margin-top: 8px;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .ds-flow-privacy.public {
      background: rgba(234, 179, 8, 0.15);
      color: #eab308;
    }

    .ds-flow-arrow {
      color: #3b82f6;
      font-size: 1.2rem;
      text-align: center;
    }

    /* Dark Pool Explainer */
    .darkpool-explainer {
      position: relative;
      overflow: hidden;
    }

    .darkpool-explainer::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, #8b8bff, transparent);
    }

    .darkpool-explainer h2 {
      font-size: 0.95rem;
      color: #8b8bff;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 6px;
    }

    .darkpool-explainer .dp-subtitle {
      color: #666;
      font-size: 0.8rem;
      margin-bottom: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .dp-why {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 24px;
    }

    .dp-why-problem, .dp-why-solution {
      padding: 16px;
      border-radius: 8px;
      font-size: 0.82rem;
      line-height: 1.6;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .dp-why-problem {
      background: rgba(239, 68, 68, 0.06);
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .dp-why-problem h3 {
      color: #ef4444;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .dp-why-problem ul { list-style: none; padding: 0; }
    .dp-why-problem li { color: #999; padding: 3px 0; }
    .dp-why-problem li::before { content: '\2717 '; color: #ef4444; }

    .dp-why-solution {
      background: rgba(139, 139, 255, 0.06);
      border: 1px solid rgba(139, 139, 255, 0.2);
    }

    .dp-why-solution h3 {
      color: #8b8bff;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .dp-why-solution ul { list-style: none; padding: 0; }
    .dp-why-solution li { color: #bbb; padding: 3px 0; }
    .dp-why-solution li::before { content: '\2713 '; color: #22c55e; }

    /* Dark Pool Flow */
    .dp-flow {
      display: grid;
      grid-template-columns: 1fr auto 1fr auto 1fr auto 1fr;
      gap: 0;
      align-items: stretch;
    }

    .dp-flow-step {
      background: #1a1a2e;
      border: 1px solid #2a2a4a;
      border-radius: 8px;
      padding: 16px 12px;
      text-align: center;
      position: relative;
    }

    .dp-flow-step.active {
      border-color: #8b8bff;
      box-shadow: 0 0 15px rgba(139, 139, 255, 0.15);
    }

    .dp-flow-step.completed {
      border-color: #22c55e;
    }

    .dp-flow-icon {
      font-size: 1.4rem;
      margin-bottom: 8px;
      display: block;
    }

    .dp-flow-label {
      font-size: 0.78rem;
      color: #e0e0e0;
      font-weight: bold;
      margin-bottom: 4px;
    }

    .dp-flow-desc {
      font-size: 0.68rem;
      color: #666;
      line-height: 1.4;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .dp-flow-privacy {
      margin-top: 8px;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.62rem;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: inline-block;
    }

    .dp-flow-privacy.private {
      background: rgba(139, 139, 255, 0.15);
      color: #8b8bff;
      border: 1px solid rgba(139, 139, 255, 0.3);
    }

    .dp-flow-privacy.public {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .dp-flow-arrow {
      display: flex;
      align-items: center;
      justify-content: center;
      color: #444;
      font-size: 1rem;
      padding: 0 4px;
    }

    .dp-flow-arrow.active {
      color: #8b8bff;
    }

    /* Live Execution Panel */
    .dp-live-panel {
      max-width: 1000px;
      margin: 0 auto 24px;
      background: #12121a;
      border: 1px solid #8b8bff;
      border-radius: 12px;
      padding: 24px;
      display: none;
      position: relative;
      overflow: hidden;
    }

    .dp-live-panel.visible {
      display: block;
      animation: panelSlideIn 0.4s ease-out;
    }

    @keyframes panelSlideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .dp-live-panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, #8b8bff, #22c55e, #8b8bff);
      background-size: 200% 100%;
      animation: shimmer 2s linear infinite;
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .dp-live-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .dp-live-title {
      font-size: 0.9rem;
      color: #8b8bff;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .dp-live-status {
      font-size: 0.75rem;
      padding: 4px 12px;
      border-radius: 12px;
      font-weight: bold;
    }

    .dp-live-status.running {
      background: rgba(234, 179, 8, 0.15);
      color: #eab308;
      border: 1px solid rgba(234, 179, 8, 0.3);
      animation: pulse 1.5s ease-in-out infinite;
    }

    .dp-live-status.complete {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .dp-live-status.failed {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .dp-live-steps {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 12px;
    }

    .dp-live-step {
      background: #1a1a25;
      border: 1px solid #2a2a35;
      border-radius: 8px;
      padding: 16px;
      transition: all 0.4s ease;
      position: relative;
    }

    .dp-live-step.waiting {
      opacity: 0.4;
    }

    .dp-live-step.active {
      border-color: #eab308;
      box-shadow: 0 0 20px rgba(234, 179, 8, 0.1);
      opacity: 1;
    }

    .dp-live-step.active .dp-live-step-icon {
      animation: spin 1.5s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .dp-live-step.done {
      border-color: #22c55e;
      opacity: 1;
    }

    .dp-live-step.failed {
      border-color: #ef4444;
      opacity: 1;
    }

    .dp-live-step-num {
      font-size: 0.65rem;
      color: #555;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .dp-live-step-icon {
      font-size: 1.3rem;
      display: block;
      margin-bottom: 8px;
    }

    .dp-live-step-name {
      font-size: 0.82rem;
      color: #e0e0e0;
      font-weight: bold;
      margin-bottom: 4px;
    }

    .dp-live-step-detail {
      font-size: 0.72rem;
      color: #888;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      line-height: 1.4;
      min-height: 36px;
    }

    .dp-live-step-time {
      font-size: 0.7rem;
      color: #555;
      margin-top: 8px;
    }

    .dp-live-step .privacy-tag {
      position: absolute;
      top: 8px;
      right: 8px;
      font-size: 0.58rem;
      padding: 2px 6px;
      border-radius: 3px;
      font-weight: bold;
      text-transform: uppercase;
    }

    .privacy-tag.encrypted {
      background: rgba(139, 139, 255, 0.15);
      color: #8b8bff;
    }

    .privacy-tag.tee {
      background: rgba(234, 179, 8, 0.15);
      color: #eab308;
    }

    .privacy-tag.zk {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }

    .dp-live-panel.direct-swap {
      border-color: #3b82f6;
    }

    .dp-live-panel.direct-swap::before {
      background: linear-gradient(90deg, #3b82f6, #22c55e, #3b82f6);
      background-size: 200% 100%;
    }

    .dp-live-panel.direct-swap .dp-live-title {
      color: #3b82f6;
    }

    .dp-live-panel.direct-swap .dp-live-steps {
      grid-template-columns: 1fr 1fr 1fr;
    }

    .dp-live-data-reveal {
      margin-top: 16px;
      padding: 12px 16px;
      background: #1a1a25;
      border-radius: 8px;
      border: 1px solid #2a2a35;
    }

    .dp-live-data-reveal h4 {
      font-size: 0.72rem;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .data-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      font-size: 0.78rem;
    }

    .data-label { color: #888; }

    .data-value { color: #e0e0e0; font-weight: bold; }

    .data-value.hidden-val {
      color: #8b8bff;
      font-style: italic;
      font-weight: normal;
    }

    .data-value.revealed {
      color: #22c55e;
    }

    /* Mechanism Comparison */
    .mechanism-compare {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 16px;
    }

    .mech-card {
      padding: 16px;
      border-radius: 8px;
      border: 1px solid #2a2a35;
    }

    .mech-card.direct-card {
      background: rgba(34, 197, 94, 0.03);
      border-color: rgba(34, 197, 94, 0.2);
    }

    .mech-card.darkpool-card {
      background: rgba(139, 139, 255, 0.03);
      border-color: rgba(139, 139, 255, 0.2);
    }

    .mech-card h3 {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
    }

    .mech-card.direct-card h3 { color: #22c55e; }
    .mech-card.darkpool-card h3 { color: #8b8bff; }

    .mech-attr {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px 0;
      font-size: 0.75rem;
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }

    .mech-attr:last-child { border-bottom: none; }

    .mech-attr-label { color: #888; }

    .mech-attr-value { font-weight: bold; }

    .mech-attr-value.good { color: #22c55e; }
    .mech-attr-value.warn { color: #eab308; }
    .mech-attr-value.bad { color: #ef4444; }
    .mech-attr-value.neutral { color: #e0e0e0; }

    /* Responsive for dark pool sections */
    @media (max-width: 768px) {
      .dp-why {
        grid-template-columns: 1fr;
      }

      .dp-flow {
        grid-template-columns: 1fr;
        gap: 8px;
      }

      .dp-flow-arrow {
        transform: rotate(90deg);
        padding: 4px 0;
      }

      .dp-live-steps {
        grid-template-columns: 1fr;
      }

      .dp-live-panel.direct-swap .dp-live-steps {
        grid-template-columns: 1fr;
      }

      .mechanism-compare {
        grid-template-columns: 1fr;
      }
    }

    /* Footer */
    .dashboard-footer {
      max-width: 1000px;
      margin: 32px auto 0;
      padding: 20px 0;
      border-top: 1px solid #1a1a25;
      text-align: center;
    }

    .tech-badges {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .tech-badge {
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.7rem;
      background: #1a1a25;
      color: #888;
      border: 1px solid #222;
    }

    .footer-links {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-top: 8px;
    }

    .footer-links a {
      color: #666;
      font-size: 0.75rem;
      text-decoration: none;
      transition: color 0.2s;
    }

    .footer-links a:hover { color: #8b8bff; }

    /* Responsive */
    @media (max-width: 768px) {
      body { padding: 16px; }

      .grid {
        grid-template-columns: 1fr;
      }

      .card.full-width {
        grid-column: 1;
      }

      .arch-flow {
        flex-direction: column;
        align-items: center;
        gap: 0;
      }

      .arch-step {
        width: 100%;
        max-width: 280px;
      }

      .arch-arrow {
        transform: rotate(90deg);
        margin: 4px 0;
      }

      .metrics-grid {
        grid-template-columns: 1fr;
      }

      .demo-btn-group {
        flex-direction: column;
        align-items: center;
      }


      .toast-container {
        left: 16px;
        right: 16px;
        bottom: 16px;
      }

      .toast {
        max-width: 100%;
      }
    }

    /* Disclaimer modal */
    .disclaimer-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.75);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .disclaimer-box {
      background: #1a0a0a;
      border: 2px solid #ef4444;
      border-radius: 12px;
      padding: 32px;
      max-width: 560px;
      width: 100%;
      box-shadow: 0 0 40px rgba(239, 68, 68, 0.3);
    }

    .disclaimer-box h2 {
      color: #ef4444;
      font-size: 1.1rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 16px;
      text-align: center;
    }

    .disclaimer-box p {
      color: #e0e0e0;
      font-size: 0.88rem;
      line-height: 1.7;
      margin-bottom: 12px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .disclaimer-box .dismiss-btn {
      display: block;
      margin: 20px auto 0;
      background: #ef4444;
      color: #fff;
      border: none;
      padding: 10px 32px;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: bold;
      cursor: pointer;
      letter-spacing: 1px;
    }

    .disclaimer-box .dismiss-btn:hover {
      background: #dc2626;
    }
  </style>
</head>
<body>
  <!-- Disclaimer Modal -->
  <div class="disclaimer-overlay" id="disclaimerModal">
    <div class="disclaimer-box">
      <h2>Simulation Only</h2>
      <p>This is a <strong>simulation</strong> and does not reflect the actual state of wBTC reserves. The real wBTC reserves are completely fine. Live Chainlink PoR data is used as a realistic anchor, but in production this data would flow through a private custodian API directly into the CRE TEE &mdash; never via a public feed.</p>
      <p>This demo demonstrates how a confidential proof-of-reserve system would respond to hypothetical undercollateralization scenarios, offering an alternative to transparent PoR where only a boolean solvency attestation is published on-chain.</p>
      <button class="dismiss-btn" onclick="document.getElementById('disclaimerModal').style.display='none'">I Understand</button>
    </div>
  </div>

  <h1>CRE Powered Self-Healing Reserve</h1>
  <p class="subtitle">Live Dashboard // Chainlink Runtime Environment + Autonomous Recovery</p>

  <p class="description">
    A confidential alternative to transparent Proof of Reserve. In production, reserve balances flow from the custodian's private API directly into a Chainlink CRE Trusted Execution Environment. They never touch a public feed. The TEE verifies solvency and publishes only a boolean attestation on-chain. When undercollateralization is detected, an AI agent selects the optimal recovery strategy: direct Uniswap swaps for small deficits, or confidential dark pool execution via Chainlink Confidential Compute (CCC) for large ones, with end-to-end private token transfers where market impact matters. No human intervention required. This demo uses live Chainlink wBTC PoR data as a realistic simulation anchor.
  </p>

  <!-- Architecture Flow -->
  <div class="arch-flow">
    <div class="arch-step">
      <div class="arch-step-num">1</div>
      <div class="arch-label">Reserve API</div>
      <div class="arch-desc">Private custodian API feeds reserve data into TEE</div>
    </div>
    <div class="arch-arrow">&rarr;</div>
    <div class="arch-step">
      <div class="arch-step-num">2</div>
      <div class="arch-label">TEE Verification</div>
      <div class="arch-desc">CRE workflow privately verifies solvency inside trusted enclave</div>
    </div>
    <div class="arch-arrow">&rarr;</div>
    <div class="arch-step">
      <div class="arch-step-num">3</div>
      <div class="arch-label">On-Chain Attestation</div>
      <div class="arch-desc">Boolean solvency result published to smart contract</div>
    </div>
    <div class="arch-arrow">&rarr;</div>
    <div class="arch-step">
      <div class="arch-step-num">4</div>
      <div class="arch-label">Agent Detection</div>
      <div class="arch-desc">Monitors contract for undercollateralization events</div>
    </div>
    <div class="arch-arrow">&rarr;</div>
    <div class="arch-step">
      <div class="arch-step-num">5</div>
      <div class="arch-label">Wallet Recovery</div>
      <div class="arch-desc">Autonomous swap and transfer via MPC wallet</div>
    </div>
  </div>

  <!-- Live Data -->
  <div class="grid">
    <!-- Status -->
    <div class="card">
      <h2>Attestation Status</h2>
      <div class="status-block">
        <div class="status-dot" id="status-dot"></div>
        <span class="status-label" id="status-label">---</span>
      </div>
      <div style="margin-top: 16px;">
        <div class="stat-row">
          <span class="stat-label">Contract</span>
          <span class="stat-value" id="contract-solvent">---</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Check Frequency</span>
          <span class="stat-value">Every block (~12s)</span>
        </div>
      </div>
    </div>

    <!-- Reserves -->
    <div class="card">
      <h2 id="reserve-card-title">Reserve Data</h2>
      <div id="chainlink-feed-info" style="font-size:0.75rem;color:#666;margin:-10px 0 12px;display:none;">
        <span id="feed-description"></span>
        <span id="feed-address" style="margin-left:8px;color:#555;cursor:default;" title=""></span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Total Reserve</span>
        <span class="stat-value" id="total-reserve">---</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Total Liabilities</span>
        <span class="stat-value" id="total-liabilities">---</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Ratio</span>
        <span class="stat-value" id="ratio-value">---</span>
      </div>
      <div class="stat-row" id="feed-updated-row" style="display:none;">
        <span class="stat-label">Feed Updated</span>
        <span class="stat-value" id="feed-updated" style="font-size:0.85rem;">---</span>
      </div>
      <div class="stat-row" id="feed-round-row" style="display:none;">
        <span class="stat-label">Round</span>
        <span class="stat-value" id="feed-round" style="font-size:0.85rem;">---</span>
      </div>
      <div class="ratio-bar-container">
        <div class="ratio-label">
          <span>0%</span>
          <span>100%</span>
          <span>200%</span>
        </div>
        <div class="ratio-bar-track">
          <div class="ratio-bar-fill" id="ratio-bar"></div>
          <div class="ratio-threshold"></div>
          <div class="ratio-threshold-label">Solvency Threshold</div>
        </div>
      </div>
      <div id="ratio-chart" style="margin-top:20px;"></div>
    </div>
  </div>

  <!-- Demo Controls -->
  <div class="demo-controls">
    <h2>Demo Controls</h2>
    <p class="demo-desc">Trigger scenarios to see the self-healing pipeline in action. The agent automatically selects the recovery mechanism based on deficit size.</p>
    <div class="demo-btn-group">
      <button id="btn-simulate" class="btn btn-primary" onclick="simulateRecovery()">Small Deficit &mdash; Direct Swap</button>
      <button id="btn-simulate-large" class="btn btn-darkpool" onclick="simulateLargeDeficit()">Large Deficit &mdash; Dark Pool</button>
      <button id="btn-simulate-fail" class="btn btn-danger-outline" onclick="simulateFailure()">Dark Pool Failure</button>
      <button class="btn" onclick="resetSimulation()" style="margin-left: 8px; opacity: 0.7;">Reset</button>
    </div>
  </div>

  <!-- Live Execution Panels (shown during simulation) -->
  <div class="dp-live-panel direct-swap" id="ds-live-panel">
    <div class="dp-live-header">
      <span class="dp-live-title">Direct Wallet Recovery</span>
      <span class="dp-live-status" id="ds-live-status">Initializing</span>
    </div>

    <div class="dp-live-steps">
      <div class="dp-live-step waiting" id="ds-step-1">
        <span class="privacy-tag" style="background:rgba(59,130,246,0.15);color:#3b82f6;">Wallet</span>
        <div class="dp-live-step-num">Step 1</div>
        <div class="dp-live-step-icon">&#128179;</div>
        <div class="dp-live-step-name">Check Balance</div>
        <div class="dp-live-step-detail" id="ds-step-1-detail">Waiting...</div>
        <div class="dp-live-step-time" id="ds-step-1-time"></div>
      </div>
      <div class="dp-live-step waiting" id="ds-step-2">
        <span class="privacy-tag" style="background:rgba(234,179,8,0.15);color:#eab308;">On-Chain</span>
        <div class="dp-live-step-num">Step 2</div>
        <div class="dp-live-step-icon">&#128260;</div>
        <div class="dp-live-step-name">Swap</div>
        <div class="dp-live-step-detail" id="ds-step-2-detail">Waiting...</div>
        <div class="dp-live-step-time" id="ds-step-2-time"></div>
      </div>
      <div class="dp-live-step waiting" id="ds-step-3">
        <span class="privacy-tag" style="background:rgba(34,197,94,0.15);color:#22c55e;">Transfer</span>
        <div class="dp-live-step-num">Step 3</div>
        <div class="dp-live-step-icon">&#9989;</div>
        <div class="dp-live-step-name">Send to Reserve</div>
        <div class="dp-live-step-detail" id="ds-step-3-detail">Waiting...</div>
        <div class="dp-live-step-time" id="ds-step-3-time"></div>
      </div>
    </div>

    <div class="dp-live-data-reveal" id="ds-data-reveal" style="display:none;">
      <h4>Transaction Report</h4>
      <div class="data-row">
        <span class="data-label">Wallet Balance</span>
        <span class="data-value" id="ds-data-balance" style="color:#555;">Checking...</span>
      </div>
      <div class="data-row">
        <span class="data-label">Swap Route</span>
        <span class="data-value" id="ds-data-route" style="color:#555;">Pending...</span>
      </div>
      <div class="data-row">
        <span class="data-label">Amount Recovered</span>
        <span class="data-value" id="ds-data-amount" style="color:#555;">Pending...</span>
      </div>
      <div class="data-row">
        <span class="data-label">On-Chain Visibility</span>
        <span class="data-value" id="ds-data-visibility" style="color:#eab308;">All transactions public</span>
      </div>
    </div>
  </div>

  <div class="dp-live-panel" id="dp-live-panel">
    <div class="dp-live-header">
      <span class="dp-live-title">CCC Dark Pool Execution</span>
      <span class="dp-live-status" id="dp-live-status">Initializing</span>
    </div>

    <div class="dp-live-steps">
      <div class="dp-live-step waiting" id="dp-step-1">
        <span class="privacy-tag encrypted">CCC Threshold</span>
        <div class="dp-live-step-num">Step 1</div>
        <div class="dp-live-step-icon">&#128274;</div>
        <div class="dp-live-step-name">Encrypt</div>
        <div class="dp-live-step-detail" id="dp-step-1-detail">Waiting...</div>
        <div class="dp-live-step-time" id="dp-step-1-time"></div>
      </div>
      <div class="dp-live-step waiting" id="dp-step-2">
        <span class="privacy-tag encrypted">Shielded</span>
        <div class="dp-live-step-num">Step 2</div>
        <div class="dp-live-step-icon">&#128225;</div>
        <div class="dp-live-step-name">Submit</div>
        <div class="dp-live-step-detail" id="dp-step-2-detail">Waiting...</div>
        <div class="dp-live-step-time" id="dp-step-2-time"></div>
      </div>
      <div class="dp-live-step waiting" id="dp-step-3">
        <span class="privacy-tag tee">CCC Enclave</span>
        <div class="dp-live-step-num">Step 3</div>
        <div class="dp-live-step-icon">&#128737;</div>
        <div class="dp-live-step-name">Match + Transfer</div>
        <div class="dp-live-step-detail" id="dp-step-3-detail">Waiting...</div>
        <div class="dp-live-step-time" id="dp-step-3-time"></div>
      </div>
      <div class="dp-live-step waiting" id="dp-step-4">
        <span class="privacy-tag zk">CCC Attestation</span>
        <div class="dp-live-step-num">Step 4</div>
        <div class="dp-live-step-icon">&#9989;</div>
        <div class="dp-live-step-name">Settle</div>
        <div class="dp-live-step-detail" id="dp-step-4-detail">Waiting...</div>
        <div class="dp-live-step-time" id="dp-step-4-time"></div>
      </div>
    </div>

    <div class="dp-live-data-reveal" id="dp-data-reveal" style="display:none;">
      <h4>Confidentiality Report</h4>
      <div class="data-row">
        <span class="data-label">Order Amount</span>
        <span class="data-value hidden-val" id="dp-data-amount">&#128274; CCC Threshold Encrypted</span>
      </div>
      <div class="data-row">
        <span class="data-label">Counterparties</span>
        <span class="data-value hidden-val" id="dp-data-parties">&#128274; Hidden in CCC Enclave</span>
      </div>
      <div class="data-row">
        <span class="data-label">Fill Price</span>
        <span class="data-value hidden-val" id="dp-data-price">&#128274; Hidden in CCC Enclave</span>
      </div>
      <div class="data-row">
        <span class="data-label">Settlement</span>
        <span class="data-value hidden-val" id="dp-data-settlement">&#128274; CCC Private Token Transfer</span>
      </div>
      <div class="data-row">
        <span class="data-label">On-Chain Proof</span>
        <span class="data-value" id="dp-data-proof" style="color:#555;">Pending...</span>
      </div>
      <div class="data-row">
        <span class="data-label">Public Information</span>
        <span class="data-value" id="dp-data-public" style="color:#555;">None yet</span>
      </div>
    </div>
  </div>

  <!-- Recovery Mechanism Tabs -->
  <div class="recovery-tabs" id="recovery-tabs">
    <div class="recovery-tab-nav" id="recovery-tab-nav">
      <button class="recovery-tab-btn active" data-tab="cover">Recovery Mechanism</button>
      <button class="recovery-tab-btn" data-tab="direct">Direct Wallet Swap</button>
      <button class="recovery-tab-btn" data-tab="darkpool">CCC Dark Pool</button>
      <button class="recovery-tab-btn" data-tab="failure">Dark Pool Failure</button>
    </div>

    <!-- Cover Tab (default) -->
    <div class="recovery-tab-content active" id="tab-cover">
      <div class="tab-cover-intro">
        <h2>Dual Recovery Architecture</h2>
        <p>When the CRE TEE detects undercollateralization, an autonomous agent selects the optimal recovery path based on deficit size. Small deficits swap directly on-chain; large deficits route through a confidential dark pool where no one sees the order size, counterparties, or fill price.</p>
        <p class="tab-cover-cta">Trigger a simulation above to see the recovery pipeline in action.</p>
      </div>

      <div class="mechanism-compare">
        <div class="mech-card direct-card">
          <h3>Direct Wallet Swap</h3>
          <div class="mech-attr">
            <span class="mech-attr-label">Use Case</span>
            <span class="mech-attr-value neutral">Deficits &lt; $50M</span>
          </div>
          <div class="mech-attr">
            <span class="mech-attr-label">Execution Venue</span>
            <span class="mech-attr-value neutral">Uniswap (Public DEX)</span>
          </div>
          <div class="mech-attr">
            <span class="mech-attr-label">Transaction Visibility</span>
            <span class="mech-attr-value bad">Fully Public</span>
          </div>
          <div class="mech-attr">
            <span class="mech-attr-label">Market Impact</span>
            <span class="mech-attr-value warn">Moderate Slippage</span>
          </div>
          <div class="mech-attr">
            <span class="mech-attr-label">MEV Protection</span>
            <span class="mech-attr-value bad">None</span>
          </div>
          <div class="mech-attr">
            <span class="mech-attr-label">Amount Privacy</span>
            <span class="mech-attr-value bad">Exposed On-Chain</span>
          </div>
          <div class="mech-attr">
            <span class="mech-attr-label">Token Transfer Privacy</span>
            <span class="mech-attr-value bad">None (Public ERC-20 Transfers)</span>
          </div>
          <div class="mech-attr">
            <span class="mech-attr-label">Speed</span>
            <span class="mech-attr-value good">~300ms</span>
          </div>
          <div class="mech-attr">
            <span class="mech-attr-label">Complexity</span>
            <span class="mech-attr-value good">Low (3 steps)</span>
          </div>
        </div>
        <div class="mech-card darkpool-card">
          <h3>CCC Confidential Dark Pool</h3>
          <div class="mech-attr">
            <span class="mech-attr-label">Use Case</span>
            <span class="mech-attr-value neutral">Deficits &gt; $50M</span>
          </div>
          <div class="mech-attr">
            <span class="mech-attr-label">Execution Venue</span>
            <span class="mech-attr-value neutral">CCC Compute Enclave</span>
          </div>
          <div class="mech-attr">
            <span class="mech-attr-label">Transaction Visibility</span>
            <span class="mech-attr-value good">Boolean + Encrypted Hash</span>
          </div>
          <div class="mech-attr">
            <span class="mech-attr-label">Market Impact</span>
            <span class="mech-attr-value good">Zero</span>
          </div>
          <div class="mech-attr">
            <span class="mech-attr-label">MEV Protection</span>
            <span class="mech-attr-value good">Full (CCC + Threshold Encryption)</span>
          </div>
          <div class="mech-attr">
            <span class="mech-attr-label">Amount Privacy</span>
            <span class="mech-attr-value good">CCC Threshold Encrypted</span>
          </div>
          <div class="mech-attr">
            <span class="mech-attr-label">Token Transfer Privacy</span>
            <span class="mech-attr-value good">Full (CCC Private Token Transfer)</span>
          </div>
          <div class="mech-attr">
            <span class="mech-attr-label">Speed</span>
            <span class="mech-attr-value warn">~2.2s</span>
          </div>
          <div class="mech-attr">
            <span class="mech-attr-label">Complexity</span>
            <span class="mech-attr-value good">Fully Automated (4 steps + CCC)</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Direct Swap Tab -->
    <div class="recovery-tab-content" id="tab-direct">
      <div class="directswap-explainer">
        <h2>Direct Wallet Swap Recovery</h2>
        <p class="ds-subtitle">For deficits under $50M, the agent executes a fast 3-step recovery using a direct on-chain swap via Uniswap &mdash; simple, fast, and fully transparent.</p>

        <div class="ds-why">
          <div class="ds-why-when">
            <h3>When It&rsquo;s Used</h3>
            <ul>
              <li>Deficit is below the $50M threshold</li>
              <li>Market impact from the swap is tolerable</li>
              <li>Speed of recovery is the top priority</li>
              <li>No confidentiality concerns at this scale</li>
            </ul>
          </div>
          <div class="ds-why-how">
            <h3>How It Works</h3>
            <ul>
              <li>Agent wallet USDC balance is checked on-chain</li>
              <li>Swap routed through Uniswap V3 for best rate</li>
              <li>Recovered wBTC sent directly to the reserve</li>
              <li>Full transaction trail visible on Etherscan</li>
            </ul>
          </div>
        </div>

        <div class="ds-flow">
          <div class="ds-flow-step">
            <div class="ds-flow-icon">&#128179;</div>
            <div class="ds-flow-label">Check Balance</div>
            <div class="ds-flow-desc">Verify agent wallet has enough USDC to cover the deficit amount.</div>
            <span class="ds-flow-privacy public">&#9888; Public</span>
          </div>
          <div class="ds-flow-arrow">&#10132;</div>
          <div class="ds-flow-step">
            <div class="ds-flow-icon">&#128260;</div>
            <div class="ds-flow-label">DEX Swap</div>
            <div class="ds-flow-desc">Swap USDC &rarr; wBTC on Uniswap V3 at market rate. Visible in the mempool.</div>
            <span class="ds-flow-privacy public">&#9888; Public</span>
          </div>
          <div class="ds-flow-arrow">&#10132;</div>
          <div class="ds-flow-step">
            <div class="ds-flow-icon">&#9989;</div>
            <div class="ds-flow-label">Send to Reserve</div>
            <div class="ds-flow-desc">Transfer recovered wBTC back into the reserve fund to restore collateralization.</div>
            <span class="ds-flow-privacy public">&#9888; Public</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Dark Pool Tab -->
    <div class="recovery-tab-content" id="tab-darkpool">
      <div class="darkpool-explainer">
        <h2>CCC Confidential Dark Pool Recovery</h2>
        <p class="dp-subtitle">When deficits exceed $50M, recovery routes through a confidential dark pool powered by <strong>Chainlink Confidential Compute (CCC)</strong> &mdash; end-to-end confidential from encryption through settlement.</p>

        <div class="dp-why">
          <div class="dp-why-problem">
            <h3>The Problem: Public Recovery</h3>
            <ul>
              <li>Large swaps on Uniswap move the market</li>
              <li>MEV bots front-run recovery transactions</li>
              <li>Competitors see exact deficit amount on-chain</li>
              <li>Token transfers reveal amounts and counterparties</li>
            </ul>
          </div>
          <div class="dp-why-solution">
            <h3>The Solution: CCC Private Token Transfers</h3>
            <ul>
              <li>Order amount CCC threshold-encrypted (no single node can decrypt)</li>
              <li>Vault DON re-encrypts inputs for assigned CCC enclave</li>
              <li>Settlement via CCC private token transfer inside enclave</li>
              <li>On-chain: only encrypted balance hash + boolean + attestation</li>
            </ul>
          </div>
        </div>

        <div class="dp-flow">
          <div class="dp-flow-step" id="dp-explain-1">
            <span class="dp-flow-icon">&#128274;</span>
            <div class="dp-flow-label">CCC Threshold Encrypt</div>
            <div class="dp-flow-desc">Deficit amount encrypted with CCC master public key. Threshold-shared across Vault DON &mdash; no single node can decrypt.</div>
            <span class="dp-flow-privacy private">&#128274; Threshold Encrypted</span>
          </div>
          <div class="dp-flow-arrow">&#10132;</div>
          <div class="dp-flow-step" id="dp-explain-2">
            <span class="dp-flow-icon">&#128225;</span>
            <div class="dp-flow-label">Submit to Pool</div>
            <div class="dp-flow-desc">Encrypted request submitted to CREDarkPool contract. Contract stores encrypted blob &mdash; never sees plaintext.</div>
            <span class="dp-flow-privacy private">&#128274; Encrypted</span>
          </div>
          <div class="dp-flow-arrow">&#10132;</div>
          <div class="dp-flow-step" id="dp-explain-3">
            <span class="dp-flow-icon">&#128737;</span>
            <div class="dp-flow-label">CCC Enclave Match + Transfer</div>
            <div class="dp-flow-desc">Vault DON provides re-encrypted key shares. Enclave decrypts, matches orders, and settles via CCC private token transfer. Balances updated inside TEE.</div>
            <span class="dp-flow-privacy private">&#128274; CCC Enclave</span>
          </div>
          <div class="dp-flow-arrow">&#10132;</div>
          <div class="dp-flow-step" id="dp-explain-4">
            <span class="dp-flow-icon">&#9989;</span>
            <div class="dp-flow-label">CCC Attestation</div>
            <div class="dp-flow-desc">Enclave re-encrypts updated balance table. On-chain receives only: encrypted balance hash + boolean &ldquo;recovery succeeded&rdquo; + quorum-signed CCC attestation.</div>
            <span class="dp-flow-privacy public">&#10003; Quorum-Signed</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Failure Tab -->
    <div class="recovery-tab-content" id="tab-failure">
      <div class="failure-explainer">
        <h2>Dark Pool Recovery Failed</h2>
        <p class="fail-subtitle">The CCC enclave could not fill the recovery order. The dark pool does not have enough pre-committed liquidity to match the deficit &mdash; the reserve stays undercollateralized until manual intervention or a retry.</p>

        <div class="fail-why">
          <div class="fail-why-what">
            <h3>What Happened</h3>
            <ul>
              <li>Deficit exceeded available dark pool liquidity</li>
              <li>CCC enclave matching timed out after scanning all committed market makers</li>
              <li>No partial fills &mdash; the dark pool is all-or-nothing to prevent information leakage</li>
              <li>Order expired without settlement; deficit amount remains hidden</li>
            </ul>
          </div>
          <div class="fail-why-next">
            <h3>What Happens Next</h3>
            <ul>
              <li>Reserve stays undercollateralized &mdash; no automatic fallback</li>
              <li>On-chain attestation still reads <code>isSolvent = false</code></li>
              <li>Manual intervention required: add liquidity providers or retry with different parameters</li>
              <li>Privacy preserved &mdash; no one learned the order size or that the pool was insufficient</li>
            </ul>
          </div>
        </div>

        <div class="dp-flow">
          <div class="dp-flow-step" style="border-color: #22c55e;">
            <span class="dp-flow-icon">&#128274;</span>
            <div class="dp-flow-label">CCC Threshold Encrypt</div>
            <div class="dp-flow-desc">Deficit encrypted successfully.</div>
            <span class="dp-flow-privacy private">&#128274; Threshold Encrypted</span>
          </div>
          <div class="dp-flow-arrow">&#10132;</div>
          <div class="dp-flow-step" style="border-color: #22c55e;">
            <span class="dp-flow-icon">&#128225;</span>
            <div class="dp-flow-label">Submit to Pool</div>
            <div class="dp-flow-desc">Encrypted order submitted to contract.</div>
            <span class="dp-flow-privacy private">&#128274; Encrypted</span>
          </div>
          <div class="dp-flow-arrow">&#10132;</div>
          <div class="dp-flow-step" style="border-color: #ef4444;">
            <span class="dp-flow-icon" style="color: #ef4444;">&#10007;</span>
            <div class="dp-flow-label">CCC Enclave Match</div>
            <div class="dp-flow-desc" style="color: #ef4444;">Timed out. Insufficient liquidity committed by market makers to fill the order.</div>
            <span class="dp-flow-privacy" style="background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3);">&#10007; Timed Out</span>
          </div>
          <div class="dp-flow-arrow" style="color: #333;">&#10132;</div>
          <div class="dp-flow-step" style="border-color: #333; opacity: 0.4;">
            <span class="dp-flow-icon">&#9989;</span>
            <div class="dp-flow-label">CCC Attestation</div>
            <div class="dp-flow-desc">Skipped &mdash; previous step failed.</div>
            <span class="dp-flow-privacy" style="background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3);">&#10007; Skipped</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Operational Details -->
  <div class="grid">
    <!-- Recovery Strategies -->
    <div class="card full-width">
      <h2>Recovery Strategies</h2>
      <div style="margin-bottom: 12px;">
        <div class="stat-row">
          <span class="stat-label">Current Strategy</span>
          <span class="stat-value" id="strategy-label">---</span>
        </div>
      </div>
      <div id="recovery-steps">
        <div class="empty-state">No recovery executed yet. Use the demo controls above to trigger a recovery simulation.</div>
      </div>
    </div>

    <!-- Event Timeline -->
    <div class="card">
      <h2>Event Timeline</h2>
      <div class="timeline" id="event-timeline">
        <div class="empty-state">Waiting for events...</div>
      </div>
    </div>

    <!-- Agent Metrics -->
    <div class="card">
      <h2>Agent Metrics</h2>
      <div id="agent-metrics-content">
        <div class="empty-state">Waiting for agent reports...</div>
      </div>
    </div>

    <!-- Agent Activity -->
    <div class="card full-width">
      <h2>Agent Activity</h2>
      <div class="timeline" id="agent-activity">
        <div class="empty-state">No recovery actions yet.</div>
      </div>
    </div>
  </div>

  <footer style="max-width:1000px; margin:40px auto 0; padding:24px 0 32px; border-top:1px solid #222; text-align:center;">
    <div style="display:flex; justify-content:center; gap:16px; flex-wrap:wrap; margin-bottom:16px;">
      <a href="https://github.com/ct1212/self-healing-reserve" target="_blank" rel="noopener" style="color:#e0e0e0; background:#1a1a25; border:1px solid #333; padding:8px 18px; border-radius:6px; font-size:0.8rem; text-decoration:none; display:inline-flex; align-items:center; gap:6px;">
        <svg height="16" width="16" viewBox="0 0 16 16" fill="#e0e0e0"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
        GitHub
      </a>
      <a href="https://github.com/ct1212/self-healing-reserve#readme" target="_blank" rel="noopener" style="color:#e0e0e0; background:#1a1a25; border:1px solid #333; padding:8px 18px; border-radius:6px; font-size:0.8rem; text-decoration:none;">
        README
      </a>
      <button onclick="shareProject()" style="color:#e0e0e0; background:#1a1a25; border:1px solid #333; padding:8px 18px; border-radius:6px; font-size:0.8rem; cursor:pointer; font-family:inherit; display:inline-flex; align-items:center; gap:6px;">
        <svg height="14" width="14" viewBox="0 0 24 24" fill="none" stroke="#e0e0e0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
        Share
      </button>
    </div>
    <div style="color:#555; font-size:0.75rem; letter-spacing:0.5px;">
      Built for <span style="color:#8b8bff;">Chainlink Convergence Hackathon 2026</span>
    </div>
  </footer>

  <!-- Toast container -->
  <div id="toast-container" class="toast-container"></div>

  <script>
    const API = 'api/status';
    let lastEventCount = 0;
    let alertHistoryVisible = false;
    let animationTimers = [];

    function shareProject() {
      var url = 'https://self-healing-reserve.vercel.app';
      var text = 'CRE Powered Self-Healing Reserve: Confidential proof-of-reserve with autonomous recovery, built on Chainlink CRE';
      if (navigator.share) {
        navigator.share({ title: 'Self-Healing Reserve', text: text, url: url });
      } else {
        navigator.clipboard.writeText(url).then(function() {
          showToast('Link Copied', 'URL copied to clipboard.', 'info');
        });
      }
    }

    const STEP_LABELS = {
      checkBalance: { name: 'Check Wallet Balance', desc: 'Verify USDC available for recovery swap' },
      trade: { name: 'Uniswap DEX Swap', desc: 'Swap USDC to wBTC on Uniswap' },
      send: { name: 'Send to Reserve', desc: 'Transfer wBTC back to the reserve fund' },
      encryptRequest: { name: 'CCC Threshold Encrypt', desc: 'Encrypt deficit with CCC master public key (threshold encryption)' },
      submitToPool: { name: 'Submit to Dark Pool', desc: 'Submit encrypted order to CCC confidential dark pool' },
      monitorFill: { name: 'CCC Enclave Match + Transfer', desc: 'CCC enclave matches orders and settles via private token transfer' },
      settle: { name: 'CCC Settlement', desc: 'Write encrypted balance hash + boolean + CCC attestation on-chain' },
    };

    function formatNumber(n) {
      return n.toLocaleString('en-US');
    }

    function formatReserveNumber(n) {
      if (Math.abs(n) >= 1e9) {
        return n.toLocaleString('en-US', { maximumFractionDigits: 0 });
      }
      return n.toLocaleString('en-US', { maximumFractionDigits: 2 });
    }

    function formatTime(ts) {
      if (!ts) return '---';
      const d = new Date(ts * 1000);
      return d.toLocaleTimeString();
    }

    function formatDuration(ms) {
      if (ms < 1000) return `${ms}ms`;
      if (ms < 60000) return `${(ms / 1000).toFixed(1)}s`;
      return `${(ms / 60000).toFixed(1)}m`;
    }


    function toggleAlertHistory() {
      alertHistoryVisible = !alertHistoryVisible;
      document.getElementById('alert-history').style.display = alertHistoryVisible ? 'block' : 'none';
    }

    // Toast notification system
    function showToast(title, message, type) {
      type = type || 'success';
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = 'toast toast-' + type;
      toast.innerHTML = '<div class="toast-title">' + title + '</div>' +
        (message ? '<div>' + message + '</div>' : '');
      container.appendChild(toast);

      requestAnimationFrame(function() {
        toast.classList.add('show');
      });

      setTimeout(function() {
        toast.classList.remove('show');
        setTimeout(function() { toast.remove(); }, 300);
      }, 4000);
    }

    function setSimulateLoading(btnId, loading) {
      var btn = document.getElementById(btnId);
      if (!btn) return;
      btn.disabled = loading;
      if (btnId === 'btn-simulate') {
        btn.textContent = loading ? 'Simulating...' : 'Small Deficit \u2014 Direct Swap';
      } else {
        btn.textContent = loading ? 'Simulating...' : 'Dark Pool Failure';
      }
    }

    async function testAlerts() {
      try {
        const res = await fetch('api/alerts/test', { method: 'POST' });
        const data = await res.json();
        if (data.ok) {
          showToast('Test Alert Sent', 'Alert sent to all enabled channels.', 'info');
        } else {
          showToast('Failed', 'Could not send test alert.', 'error');
        }
      } catch (err) {
        showToast('Error', err.message, 'error');
      }
    }

    function disableAllSimBtns() {
      document.getElementById('btn-simulate').disabled = true;
      document.getElementById('btn-simulate-large').disabled = true;
      document.getElementById('btn-simulate-fail').disabled = true;
    }

    function enableAllSimBtns() {
      var b1 = document.getElementById('btn-simulate');
      var b2 = document.getElementById('btn-simulate-large');
      var b3 = document.getElementById('btn-simulate-fail');
      b1.disabled = false; b1.textContent = 'Small Deficit \u2014 Direct Swap';
      b2.disabled = false; b2.textContent = 'Large Deficit \u2014 Dark Pool';
      b3.disabled = false; b3.textContent = 'Dark Pool Failure';
    }

    async function simulateRecovery() {
      var btn = document.getElementById('btn-simulate');
      disableAllSimBtns();
      btn.textContent = 'Triggering...';
      try {
        var res = await fetch('api/simulate', { method: 'POST' });
        var data = await res.json();
        if (data.ok) {
          showToast(
            'Undercollateralized!',
            'Reserve ratio dropped to ' + data.data.ratio + '%. Agent swapping via wallet...',
            'error'
          );
          animateDirectSwap(data.data);
          poll();
        } else {
          showToast('Simulation Failed', data.error || 'Server returned an error.', 'error');
          enableAllSimBtns();
        }
      } catch (err) {
        showToast('Error', err.message, 'error');
        enableAllSimBtns();
      }
    }

    // Recovery tab switching
    function switchRecoveryTab(tabName) {
      var btns = document.querySelectorAll('.recovery-tab-btn');
      var panels = document.querySelectorAll('.recovery-tab-content');
      for (var i = 0; i < btns.length; i++) {
        btns[i].classList.toggle('active', btns[i].getAttribute('data-tab') === tabName);
      }
      for (var i = 0; i < panels.length; i++) {
        panels[i].classList.toggle('active', panels[i].id === 'tab-' + tabName);
      }
    }

    document.getElementById('recovery-tab-nav').addEventListener('click', function(e) {
      var btn = e.target.closest('.recovery-tab-btn');
      if (btn) switchRecoveryTab(btn.getAttribute('data-tab'));
    });

    // Direct Swap Live Execution Panel
    function showDSPanel() {
      // Hide dark pool panel if visible
      document.getElementById('dp-live-panel').classList.remove('visible');
      switchRecoveryTab('direct');
      var panel = document.getElementById('ds-live-panel');
      panel.classList.add('visible');
      for (var i = 1; i <= 3; i++) {
        var step = document.getElementById('ds-step-' + i);
        step.className = 'dp-live-step waiting';
        document.getElementById('ds-step-' + i + '-detail').textContent = 'Waiting...';
        document.getElementById('ds-step-' + i + '-time').textContent = '';
      }
      var status = document.getElementById('ds-live-status');
      status.textContent = 'Executing';
      status.className = 'dp-live-status running';
      var reveal = document.getElementById('ds-data-reveal');
      reveal.style.display = '';
      document.getElementById('ds-data-balance').textContent = 'Checking...';
      document.getElementById('ds-data-balance').style.color = '#555';
      document.getElementById('ds-data-route').textContent = 'Pending...';
      document.getElementById('ds-data-route').style.color = '#555';
      document.getElementById('ds-data-amount').textContent = 'Pending...';
      document.getElementById('ds-data-amount').style.color = '#555';
      document.getElementById('ds-data-visibility').textContent = 'All transactions public';
      document.getElementById('ds-data-visibility').style.color = '#eab308';
      panel.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function setDSStep(stepNum, state, detail, timeMs) {
      var step = document.getElementById('ds-step-' + stepNum);
      step.className = 'dp-live-step ' + state;
      if (detail) document.getElementById('ds-step-' + stepNum + '-detail').textContent = detail;
      if (timeMs !== undefined) document.getElementById('ds-step-' + stepNum + '-time').textContent = timeMs + 'ms';
    }

    function setDSStatus(text, cls) {
      var status = document.getElementById('ds-live-status');
      status.textContent = text;
      status.className = 'dp-live-status ' + cls;
    }

    function scheduleAnim(fn, delay) {
      var id = setTimeout(fn, delay);
      animationTimers.push(id);
      return id;
    }

    function animateDirectSwap(recoveryData) {
      showDSPanel();
      var amount = recoveryData ? Math.round(recoveryData.recoveryAmount).toLocaleString() + ' wBTC' : '??? wBTC';
      var usdAmount = recoveryData ? '$' + Math.round(recoveryData.recoveryAmount * 67000).toLocaleString() : '$???';

      // Step 1: Check Balance (0ms - 500ms)
      scheduleAnim(function() {
        setDSStep(1, 'active', 'Querying agent wallet USDC balance...', null);
      }, 100);
      scheduleAnim(function() {
        setDSStep(1, 'done', 'Wallet has ' + usdAmount + ' USDC available for recovery.', 50);
        document.getElementById('ds-data-balance').textContent = usdAmount + ' USDC available';
        document.getElementById('ds-data-balance').style.color = '#22c55e';
      }, 600);

      // Step 2: Swap on Uniswap (600ms - 1800ms)
      scheduleAnim(function() {
        setDSStep(2, 'active', 'Submitting swap on Uniswap: USDC \u2192 wBTC at market rate...', null);
      }, 700);
      scheduleAnim(function() {
        setDSStep(2, 'active', 'Swap executing... waiting for block confirmation...', null);
      }, 1200);
      scheduleAnim(function() {
        setDSStep(2, 'done', 'Swapped ' + usdAmount + ' USDC \u2192 ' + amount + ' on Uniswap V3.', 150);
        document.getElementById('ds-data-route').textContent = 'Uniswap V3: USDC \u2192 wBTC';
        document.getElementById('ds-data-route').style.color = '#22c55e';
      }, 1800);

      // Step 3: Send to Reserve (1800ms - 2800ms)
      scheduleAnim(function() {
        setDSStep(3, 'active', 'Transferring ' + amount + ' to reserve address...', null);
      }, 1900);
      scheduleAnim(function() {
        var txHash = '0x' + Math.random().toString(16).slice(2, 10) + '...';
        setDSStep(3, 'done', 'Sent ' + amount + ' to reserve. Tx: ' + txHash, 100);
        setDSStatus('Complete', 'complete');
        document.getElementById('ds-data-amount').textContent = amount + ' recovered (' + usdAmount + ')';
        document.getElementById('ds-data-amount').style.color = '#22c55e';
        document.getElementById('ds-data-visibility').textContent = 'Swap + transfer visible on Etherscan';
        document.getElementById('ds-data-visibility').style.color = '#eab308';

        showToast(
          'Direct Swap Recovery Complete',
          'Reserve restored to 100% via Uniswap. Remaining 5% buffer via scheduled OTC.',
          'success'
        );
        poll();
        enableAllSimBtns();
      }, 2800);
    }

    // Dark Pool Live Execution Panel
    function showDPPanel() {
      // Hide direct swap panel if visible
      document.getElementById('ds-live-panel').classList.remove('visible');
      switchRecoveryTab('darkpool');
      var panel = document.getElementById('dp-live-panel');
      panel.classList.add('visible');
      // Reset all steps
      for (var i = 1; i <= 4; i++) {
        var step = document.getElementById('dp-step-' + i);
        step.className = 'dp-live-step waiting';
        document.getElementById('dp-step-' + i + '-detail').textContent = 'Waiting...';
        document.getElementById('dp-step-' + i + '-time').textContent = '';
      }
      var status = document.getElementById('dp-live-status');
      status.textContent = 'Executing';
      status.className = 'dp-live-status running';
      // Show data reveal panel
      var reveal = document.getElementById('dp-data-reveal');
      reveal.style.display = '';
      document.getElementById('dp-data-amount').textContent = '\u{1F512} CCC Threshold Encrypted';
      document.getElementById('dp-data-amount').className = 'data-value hidden-val';
      document.getElementById('dp-data-parties').textContent = '\u{1F512} Hidden in CCC Enclave';
      document.getElementById('dp-data-parties').className = 'data-value hidden-val';
      document.getElementById('dp-data-price').textContent = '\u{1F512} Hidden in CCC Enclave';
      document.getElementById('dp-data-price').className = 'data-value hidden-val';
      document.getElementById('dp-data-settlement').textContent = '\u{1F512} CCC Private Token Transfer';
      document.getElementById('dp-data-settlement').className = 'data-value hidden-val';
      document.getElementById('dp-data-proof').textContent = 'Pending...';
      document.getElementById('dp-data-proof').style.color = '#555';
      document.getElementById('dp-data-public').textContent = 'None yet';
      document.getElementById('dp-data-public').style.color = '#555';
      // Scroll into view
      panel.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function setDPStep(stepNum, state, detail, timeMs) {
      var step = document.getElementById('dp-step-' + stepNum);
      step.className = 'dp-live-step ' + state;
      if (detail) document.getElementById('dp-step-' + stepNum + '-detail').textContent = detail;
      if (timeMs !== undefined) document.getElementById('dp-step-' + stepNum + '-time').textContent = timeMs + 'ms';
    }

    function setDPStatus(text, cls) {
      var status = document.getElementById('dp-live-status');
      status.textContent = text;
      status.className = 'dp-live-status ' + cls;
    }

    function animateDPExecution(recoveryData, isFailure) {
      showDPPanel();
      var amount = recoveryData ? Math.round(recoveryData.recoveryAmount).toLocaleString() + ' wBTC' : '??? wBTC';

      // Step 1: CCC Threshold Encrypt (0ms - 500ms)
      scheduleAnim(function() {
        setDPStep(1, 'active', 'Encrypting deficit with CCC master public key (threshold encryption)...', null);
      }, 100);
      scheduleAnim(function() {
        setDPStep(1, 'done', 'CCC threshold encrypted. No single Vault DON node can decrypt.', 80);
        document.getElementById('dp-data-amount').textContent = '\u{1F512} ' + amount + ' (CCC threshold encrypted)';
      }, 600);

      // Step 2: Submit (600ms - 1200ms)
      scheduleAnim(function() {
        setDPStep(2, 'active', 'Submitting encrypted order to CREDarkPool contract...', null);
      }, 700);
      scheduleAnim(function() {
        setDPStep(2, 'done', 'Order submitted to CCC Dark Pool. Contract stores encrypted blob only.', 120);
        document.getElementById('dp-data-public').textContent = 'Order exists (amount hidden)';
        document.getElementById('dp-data-public').style.color = '#eab308';
      }, 1300);

      // Step 3: CCC Enclave Match + Private Token Transfer (1300ms - 3300ms)
      scheduleAnim(function() {
        setDPStep(3, 'active', 'Vault DON re-encrypting inputs for CCC compute enclave...', null);
      }, 1400);

      if (isFailure) {
        scheduleAnim(function() {
          setDPStep(3, 'active', 'CCC enclave matching... insufficient liquidity. Extending timeout...', null);
        }, 2400);
        scheduleAnim(function() {
          setDPStep(3, 'failed', 'CCC enclave matching timed out. Insufficient dark pool liquidity.', 5000);
          setDPStep(4, 'failed', 'Skipped - previous step failed.', 0);
          setDPStatus('Failed', 'failed');
          document.getElementById('dp-data-parties').textContent = '\u2717 No match found';
          document.getElementById('dp-data-parties').className = 'data-value';
          document.getElementById('dp-data-parties').style.color = '#ef4444';
          document.getElementById('dp-data-price').textContent = '\u2717 N/A';
          document.getElementById('dp-data-price').className = 'data-value';
          document.getElementById('dp-data-price').style.color = '#ef4444';
          document.getElementById('dp-data-settlement').textContent = '\u2717 Not executed';
          document.getElementById('dp-data-settlement').className = 'data-value';
          document.getElementById('dp-data-settlement').style.color = '#ef4444';
          document.getElementById('dp-data-proof').textContent = '\u2717 Not generated';
          document.getElementById('dp-data-proof').style.color = '#ef4444';
          document.getElementById('dp-data-public').textContent = 'Order expired (amount still hidden)';
          document.getElementById('dp-data-public').style.color = '#ef4444';
          switchRecoveryTab('failure');
        }, 3500);
      } else {
        scheduleAnim(function() {
          setDPStep(3, 'active', 'CCC enclave decrypted inputs. Matching 3 counterparties + applying private token transfers...', null);
        }, 2200);
        scheduleAnim(function() {
          setDPStep(3, 'done', 'Filled by 3 MMs via CCC private token transfer. Balances updated inside enclave.', 1800);
          document.getElementById('dp-data-parties').textContent = '3 market makers (identities hidden in CCC enclave)';
          document.getElementById('dp-data-parties').className = 'data-value';
          document.getElementById('dp-data-parties').style.color = '#22c55e';
          document.getElementById('dp-data-price').textContent = 'TWAP +/- 0.05% (exact hidden in CCC enclave)';
          document.getElementById('dp-data-price').className = 'data-value';
          document.getElementById('dp-data-price').style.color = '#22c55e';
          document.getElementById('dp-data-settlement').textContent = 'CCC private token transfer (encrypted balance update)';
          document.getElementById('dp-data-settlement').className = 'data-value';
          document.getElementById('dp-data-settlement').style.color = '#22c55e';
        }, 3300);

        // Step 4: CCC Attestation + On-chain Settlement (3300ms - 3900ms)
        scheduleAnim(function() {
          setDPStep(4, 'active', 'Enclave re-encrypting balance table. Workflow DON quorum-signing attestation...', null);
        }, 3400);
        scheduleAnim(function() {
          var cccAttestation = '0xCCC_' + Array.from({ length: 8 }, function() { return Math.random().toString(16).slice(2, 4); }).join('');
          setDPStep(4, 'done', 'CCC attestation verified. Encrypted balance hash + boolean written on-chain.', 200);
          setDPStatus('Complete', 'complete');
          document.getElementById('dp-data-proof').textContent = cccAttestation + ' (quorum-signed)';
          document.getElementById('dp-data-proof').style.color = '#22c55e';
          document.getElementById('dp-data-amount').textContent = '\u{1F512} ' + amount + ' (never revealed on-chain)';
          document.getElementById('dp-data-amount').className = 'data-value';
          document.getElementById('dp-data-amount').style.color = '#22c55e';
          document.getElementById('dp-data-public').textContent = 'Boolean: recoverySucceeded = true + encrypted balance hash + CCC attestation';
          document.getElementById('dp-data-public').style.color = '#22c55e';
        }, 4000);
      }
    }

    async function simulateLargeDeficit() {
      var btn = document.getElementById('btn-simulate-large');
      disableAllSimBtns();
      btn.textContent = 'Triggering...';
      try {
        var res = await fetch('api/simulate-large', { method: 'POST' });
        var data = await res.json();
        if (data.ok) {
          showToast(
            'Undercollateralized!',
            'Reserve ratio dropped to ' + data.data.ratio + '%. Routing to CCC confidential dark pool...',
            'error'
          );
          poll();
          btn.textContent = 'CCC dark pool executing...';
          // Start live execution animation
          animateDPExecution(data.data, false);
          scheduleAnim(function() {
            showToast(
              'CCC Dark Pool Recovery Complete',
              'Filled via CCC enclave matching + private token transfer. Only encrypted hash on-chain.',
              'success'
            );
            poll();
            enableAllSimBtns();
          }, 4500);
        } else {
          showToast('Simulation Failed', data.error || 'Server returned an error.', 'error');
          enableAllSimBtns();
        }
      } catch (err) {
        showToast('Error', err.message, 'error');
        enableAllSimBtns();
      }
    }

    async function simulateFailure() {
      var btn = document.getElementById('btn-simulate-fail');
      disableAllSimBtns();
      btn.textContent = 'Triggering...';
      try {
        var res = await fetch('api/simulate-failure', { method: 'POST' });
        var data = await res.json();
        if (data.ok) {
          showToast(
            'CCC Dark Pool Recovery Failed!',
            'CCC enclave matching timed out. Failed at: ' + data.data.failedStep,
            'error'
          );
          // Start live execution animation (failure mode)
          animateDPExecution(data.data, true);
          poll();
        } else {
          showToast('Simulation Failed', data.error || 'Server returned an error.', 'error');
        }
      } catch (err) {
        showToast('Error', err.message, 'error');
      } finally {
        scheduleAnim(function() { enableAllSimBtns(); }, 4000);
      }
    }

    async function resetSimulation() {
      try {
        await fetch('api/reset', { method: 'POST' });

        // Cancel all pending animation timers
        animationTimers.forEach(function(id) { clearTimeout(id); });
        animationTimers = [];

        // Reset event tracking
        lastEventCount = 0;

        // Hide live execution panels and reset to cover tab
        document.getElementById('ds-live-panel').classList.remove('visible');
        document.getElementById('dp-live-panel').classList.remove('visible');
        switchRecoveryTab('cover');

        // Clear toasts
        document.getElementById('toast-container').innerHTML = '';

        // Reset all UI sections to initial empty state
        document.getElementById('recovery-steps').innerHTML =
          '<div class="empty-state">No recovery executed yet. Use the demo controls above to trigger a recovery simulation.</div>';
        document.getElementById('strategy-label').textContent = '---';
        document.getElementById('event-timeline').innerHTML =
          '<div class="empty-state">Waiting for events...</div>';
        document.getElementById('agent-metrics-content').innerHTML =
          '<div class="empty-state">Waiting for agent reports...</div>';
        document.getElementById('agent-activity').innerHTML =
          '<div class="empty-state">No recovery actions yet.</div>';
        document.getElementById('ratio-chart').innerHTML =
          '<div class="empty-state" style="font-size:0.75rem;">Waiting for data points...</div>';
        var alertHistoryEl = document.getElementById('alert-history');
        if (alertHistoryEl) alertHistoryEl.innerHTML = '<div class="empty-state">No alerts yet</div>';

        // Re-enable sim buttons
        enableAllSimBtns();

        // Poll to get fresh server state
        poll();
      } catch (err) {
        showToast('Error', err.message, 'error');
      }
    }

    function renderRatioChart(history) {
      var container = document.getElementById('ratio-chart');
      if (!history || history.length < 2) {
        container.innerHTML = '<div class="empty-state" style="font-size:0.75rem;">Waiting for data points...</div>';
        return;
      }

      var W = 440, H = 140, PAD_L = 40, PAD_R = 10, PAD_T = 10, PAD_B = 24;
      var plotW = W - PAD_L - PAD_R;
      var plotH = H - PAD_T - PAD_B;
      var maxRatio = 2; // 200%
      var thresholdY = PAD_T + plotH - (1 / maxRatio) * plotH; // 100% line

      var points = history.map(function(p, i) {
        var x = PAD_L + (i / (history.length - 1)) * plotW;
        var ratio = Math.min(p.ratio, maxRatio);
        var y = PAD_T + plotH - (ratio / maxRatio) * plotH;
        return { x: x, y: y, ratio: p.ratio };
      });

      var linePath = points.map(function(p, i) {
        return (i === 0 ? 'M' : 'L') + p.x.toFixed(1) + ',' + p.y.toFixed(1);
      }).join(' ');

      // Build fill areas: green above threshold, red below
      // Clip the fill to the plot area
      var fillAbove = ''; // green area (ratio >= 100%)
      var fillBelow = ''; // red area (ratio < 100%)

      // Simple approach: one fill polygon for the whole area, colored by last value
      var lastRatio = points[points.length - 1].ratio;
      var fillColor = lastRatio >= 1 ? 'rgba(34,197,94,0.1)' : 'rgba(239,68,68,0.1)';
      var fillPath = linePath +
        ' L' + points[points.length - 1].x.toFixed(1) + ',' + (PAD_T + plotH) +
        ' L' + points[0].x.toFixed(1) + ',' + (PAD_T + plotH) + ' Z';

      // Current value dot
      var lastP = points[points.length - 1];
      var dotColor = lastP.ratio >= 1 ? '#22c55e' : '#ef4444';

      var svg = '<svg width="100%" viewBox="0 0 ' + W + ' ' + H + '" style="display:block;">' +
        // Background
        '<rect x="' + PAD_L + '" y="' + PAD_T + '" width="' + plotW + '" height="' + plotH + '" fill="#1a1a25" rx="4"/>' +
        // Y-axis labels
        '<text x="' + (PAD_L - 6) + '" y="' + (PAD_T + 4) + '" fill="#555" font-size="9" text-anchor="end" font-family="monospace">200%</text>' +
        '<text x="' + (PAD_L - 6) + '" y="' + (thresholdY + 3) + '" fill="#8b8bff" font-size="9" text-anchor="end" font-family="monospace">100%</text>' +
        '<text x="' + (PAD_L - 6) + '" y="' + (PAD_T + plotH + 4) + '" fill="#555" font-size="9" text-anchor="end" font-family="monospace">0%</text>' +
        // Threshold dashed line
        '<line x1="' + PAD_L + '" y1="' + thresholdY + '" x2="' + (PAD_L + plotW) + '" y2="' + thresholdY + '" stroke="#8b8bff" stroke-width="1" stroke-dasharray="4,3" opacity="0.5"/>' +
        // Fill area
        '<path d="' + fillPath + '" fill="' + fillColor + '"/>' +
        // Line
        '<path d="' + linePath + '" fill="none" stroke="' + dotColor + '" stroke-width="1.5"/>' +
        // Current value dot
        '<circle cx="' + lastP.x.toFixed(1) + '" cy="' + lastP.y.toFixed(1) + '" r="4" fill="' + dotColor + '"/>' +
        // Current value label
        '<text x="' + (lastP.x - 8).toFixed(1) + '" y="' + (lastP.y - 8).toFixed(1) + '" fill="' + dotColor + '" font-size="10" font-weight="bold" font-family="monospace">' + Math.round(lastP.ratio * 100) + '%</text>' +
        // X-axis label
        '<text x="' + (PAD_L + plotW / 2) + '" y="' + (H - 2) + '" fill="#444" font-size="9" text-anchor="middle" font-family="monospace">' + history.length + ' samples</text>' +
        '</svg>';

      container.innerHTML = svg;
    }

    function getStepLabel(rawName) {
      var entry = STEP_LABELS[rawName];
      return entry ? entry.name : rawName;
    }

    function getStepDesc(rawName) {
      var entry = STEP_LABELS[rawName];
      return entry ? entry.desc : '';
    }

    function update(data) {
      const { reserves, contract, events, agent, recoveries, alerts, ratioHistory } = data;

      // Ratio chart
      renderRatioChart(ratioHistory);

      // Status indicator
      const solvent = contract.isSolvent;
      const dot = document.getElementById('status-dot');
      const label = document.getElementById('status-label');
      dot.className = 'status-dot ' + (solvent ? 'solvent' : 'insolvent');
      label.className = 'status-label ' + (solvent ? 'solvent' : 'insolvent');
      label.textContent = solvent ? 'SOLVENT' : 'UNDERCOLLATERALIZED';

      // Contract state
      document.getElementById('contract-solvent').textContent = contract.isSolvent ? 'true' : 'false';

      // Reserves
      document.getElementById('total-reserve').textContent = formatReserveNumber(reserves.totalReserve);
      document.getElementById('total-liabilities').textContent = formatReserveNumber(reserves.totalLiabilities);

      const ratio = reserves.totalLiabilities > 0
        ? (reserves.totalReserve / reserves.totalLiabilities)
        : 1;
      const pct = Math.round(ratio * 100);
      document.getElementById('ratio-value').textContent = pct + '%';

      const bar = document.getElementById('ratio-bar');
      const barWidth = Math.min(pct / 2, 100);
      bar.style.width = barWidth + '%';
      bar.className = 'ratio-bar-fill ' + (pct >= 100 ? 'healthy' : pct >= 80 ? 'warning' : 'danger');

      // Chainlink feed metadata
      var feedInfoEl = document.getElementById('chainlink-feed-info');
      var feedUpdatedRow = document.getElementById('feed-updated-row');
      var feedRoundRow = document.getElementById('feed-round-row');
      var titleEl = document.getElementById('reserve-card-title');

      if (reserves.chainlink) {
        var cl = reserves.chainlink;
        titleEl.textContent = 'Reserve Data // Chainlink PoR (Demo)';
        feedInfoEl.style.display = '';
        document.getElementById('feed-description').textContent = cl.description;
        var addrShort = cl.feedAddress.slice(0, 6) + '...' + cl.feedAddress.slice(-4);
        var addrEl = document.getElementById('feed-address');
        addrEl.textContent = addrShort;
        addrEl.title = cl.feedAddress;

        feedUpdatedRow.style.display = '';
        document.getElementById('feed-updated').textContent = formatTime(cl.updatedAt);

        feedRoundRow.style.display = '';
        document.getElementById('feed-round').textContent = cl.roundId;
      } else {
        titleEl.textContent = reserves.source === 'override' ? 'Reserve Data // Simulated' : 'Reserve Data';
        feedInfoEl.style.display = 'none';
        feedUpdatedRow.style.display = 'none';
        feedRoundRow.style.display = 'none';
      }

      // Event timeline
      if (events.length !== lastEventCount) {
        const isNew = lastEventCount > 0;
        const newCount = events.length - lastEventCount;
        lastEventCount = events.length;
        const tl = document.getElementById('event-timeline');
        if (events.length === 0) {
          tl.innerHTML = '<div class="empty-state">Waiting for events...</div>';
        } else {
          tl.innerHTML = events.slice().reverse().map(function(e, i) {
            var cls = (isNew && i < newCount) ? ' new-event' : '';
            return '<div class="event-item' + cls + '">' +
              '<span class="event-dot ' + (e.isSolvent ? 'solvent' : 'insolvent') + '"></span>' +
              '<span class="event-time">' + formatTime(e.timestamp) + '</span>' +
              '<span>' + (e.isSolvent ? 'Solvent' : 'Undercollateralized') + '</span>' +
              '<span class="event-block">block #' + e.blockNumber + '</span>' +
            '</div>';
          }).join('');

          // Auto-scroll to top to show newest events
          tl.scrollTop = 0;
        }
      }

      // Agent activity
      const actEl = document.getElementById('agent-activity');
      if (agent.activities && agent.activities.length > 0) {
        actEl.innerHTML = agent.activities.slice().reverse().map(function(a) {
          return '<div class="activity-item">' +
            '<span class="activity-action">' + a.action + '</span>' +
            '<span class="activity-time">' + formatTime(a.timestamp) + '</span>' +
            (a.details ? '<div class="activity-details">' + a.details + '</div>' : '') +
          '</div>';
        }).join('');
      }

      // Agent Metrics
      if (agent.metrics) {
        const m = agent.metrics;
        const successRateClass = m.successRate >= 90 ? 'success' : m.successRate >= 70 ? 'warning' : 'danger';

        document.getElementById('agent-metrics-content').innerHTML =
          '<div class="metrics-grid">' +
            '<div class="metric-box">' +
              '<div class="metric-label">Success Rate</div>' +
              '<div class="metric-value ' + successRateClass + '">' + m.successRate.toFixed(1) + '%</div>' +
            '</div>' +
            '<div class="metric-box">' +
              '<div class="metric-label">Avg Response</div>' +
              '<div class="metric-value neutral">' + formatDuration(m.avgResponseTimeMs) + '</div>' +
            '</div>' +
            '<div class="metric-box">' +
              '<div class="metric-label">Total Recoveries</div>' +
              '<div class="metric-value neutral">' + m.totalRecoveries + '</div>' +
            '</div>' +
            '<div class="metric-box">' +
              '<div class="metric-label">Errors</div>' +
              '<div class="metric-value ' + (m.errorCount > 0 ? 'danger' : 'neutral') + '">' + m.errorCount + '</div>' +
            '</div>' +
          '</div>' +
          (m.recentErrors && m.recentErrors.length > 0 ?
            '<div style="margin-top: 12px;">' +
              '<div class="stat-label expandable" onclick="toggleErrors()">Recent Errors (' + m.recentErrors.length + ') &#9660;</div>' +
              '<div id="recent-errors" style="display: none; margin-top: 8px; max-height: 150px; overflow-y: auto;">' +
                m.recentErrors.slice().reverse().map(function(e) {
                  return '<div style="padding: 6px; background: #1a1a25; border-left: 2px solid #ef4444; margin-bottom: 4px; font-size: 0.75rem;">' +
                    '<div style="color: #ef4444; font-weight: bold;">' + e.step + '</div>' +
                    '<div style="color: #999; margin-top: 2px;">' + e.error + '</div>' +
                    '<div style="color: #666; margin-top: 2px;">' + new Date(e.timestamp).toLocaleString() + '</div>' +
                  '</div>';
                }).join('') +
              '</div>' +
            '</div>'
          : '');
      }

      // Recovery Strategies (with human-friendly labels)
      if (recoveries && recoveries.length > 0) {
        const latest = recoveries[recoveries.length - 1];
        const mech = latest.mechanism || 'direct';

        // Update strategy label
        var strategyEl = document.getElementById('strategy-label');
        if (mech === 'darkpool') {
          strategyEl.textContent = '4-Step CCC Dark Pool Recovery';
        } else {
          strategyEl.textContent = '3-Step Direct Wallet Recovery';
        }

        // Mechanism badge
        var mechBadgeHtml = '';
        if (mech === 'darkpool') {
          mechBadgeHtml = '<div class="mechanism-badge darkpool">CCC Confidential Dark Pool</div>';
        } else {
          mechBadgeHtml = '<div class="mechanism-badge direct">Direct Wallet Swap</div>';
        }

        const stepsHtml = latest.steps.map(function(s) {
          var dataHtml = '';
          if (s.data) {
            var details = [];
            if (s.data.balance) details.push(s.data.balance);
            if (s.data.amount) details.push(s.data.amount);
            if (s.data.tx) details.push('tx: ' + s.data.tx);
            if (s.data.algorithm) details.push('Encryption: ' + s.data.algorithm);
            if (s.data.orderId) details.push('Order: ' + s.data.orderId);
            if (s.data.venue) details.push(s.data.venue);
            if (s.data.fillPrice) details.push('Fill: ' + s.data.fillPrice);
            if (s.data.matchedCounterparties) details.push(s.data.matchedCounterparties + ' counterparties');
            if (s.data.settlement) details.push(s.data.settlement);
            if (s.data.zkProof) details.push('ZK proof: ' + s.data.zkProof);
            if (s.data.balanceHash) details.push('Balance hash: ' + s.data.balanceHash);
            if (s.data.cccAttestation) details.push('CCC attestation: ' + s.data.cccAttestation);
            if (s.data.onChain) details.push(s.data.onChain);
            if (s.data.settlementTx) details.push('tx: ' + s.data.settlementTx);
            if (s.data.gasUsed) details.push('Gas: ' + s.data.gasUsed);
            if (s.data.error) details.push(s.data.error);
            if (details.length > 0) {
              dataHtml = '<div class="step-data">' + details.join(' | ') + '</div>';
            }
          }
          return '<div class="recovery-step">' +
            '<div class="step-icon ' + (s.success ? 'success' : 'failure') + '">' +
              (s.success ? '&#10003;' : '&#10007;') +
            '</div>' +
            '<div class="step-info">' +
              '<div class="step-name">' + getStepLabel(s.step) + '</div>' +
              '<div class="step-desc">' + getStepDesc(s.step) + '</div>' +
              dataHtml +
              '<div class="step-duration">' + (s.durationMs ? formatDuration(s.durationMs) : '') + '</div>' +
            '</div>' +
          '</div>';
        }).join('');

        // Recovery summary message
        var summaryHtml = '';
        if (latest.summary) {
          var s = latest.summary;
          var amountStr = formatReserveNumber(s.recoveryAmount) + ' wBTC';
          var sMech = s.mechanism || 'direct';

          if (latest.success && sMech === 'darkpool') {
            summaryHtml = '<div class="recovery-summary recovery-summary-success">' +
              'Agent submitted <strong>' + amountStr + '</strong> CCC threshold-encrypted order to the dark pool. ' +
              'CCC enclave matched across 3 counterparties and settled via private token transfer. ' +
              'On-chain: only encrypted balance hash + boolean + CCC attestation. Restored to <strong>' + s.toRatio + '% collateralization</strong> ' +
              '(from ' + s.fromRatio + '% &rarr; ' + s.toRatio + '%).' +
            '</div>';
          } else if (latest.success) {
            summaryHtml = '<div class="recovery-summary recovery-summary-success">' +
              'Agent swapped $' + formatNumber(s.recoveryAmountUsd || 50000000) + ' USDC &rarr; <strong>' + amountStr + '</strong> ' +
              'via direct Uniswap swap and committed it back into the ' +
              (s.feedDescription || 'reserve') + ' fund to restore solvency ' +
              '(from ' + s.fromRatio + '% &rarr; ' + s.toRatio + '%).' +
            '</div>';
          } else if (sMech === 'darkpool') {
            summaryHtml = '<div class="recovery-summary recovery-summary-failure">' +
              'Agent attempted to fill <strong>' + amountStr + '</strong> via the CCC Confidential Dark Pool, ' +
              'but the CCC enclave matching timed out due to insufficient dark pool liquidity. ' +
              'Reserve remains at <strong>' + s.fromRatio + '% collateralization</strong>. Manual intervention required.' +
            '</div>';
          } else {
            summaryHtml = '<div class="recovery-summary recovery-summary-failure">' +
              'Recovery needed <strong>' + amountStr + '</strong> (via USDC &rarr; wBTC swap) to restore ' +
              (s.feedDescription || 'reserve') + ' fund to <strong>' + s.toRatio + '% collateralization</strong> ' +
              '(from ' + s.fromRatio + '%) but the swap failed.' +
            '</div>';
          }
        }

        document.getElementById('recovery-steps').innerHTML =
          '<div style="margin-bottom: 12px;">' +
            '<div class="stat-row">' +
              '<span class="stat-label">Latest Recovery</span>' +
              '<span class="stat-value ' + (latest.success ? 'success' : 'danger') + '">' +
                (latest.success ? 'Success' : 'Failed') + ' (' + formatDuration(latest.durationMs) + ')' +
              '</span>' +
            '</div>' +
          '</div>' +
          mechBadgeHtml +
          summaryHtml +
          stepsHtml;
      }

      // Alerts
      if (alerts) {
        document.getElementById('alerts-status').textContent = alerts.config.enabled ? 'Enabled' : 'Disabled';

        const providers = [];
        if (alerts.config.emailEnabled) providers.push('<span class="provider-badge enabled">Email</span>');
        if (alerts.config.slackEnabled) providers.push('<span class="provider-badge enabled">Slack</span>');
        if (alerts.config.discordEnabled) providers.push('<span class="provider-badge enabled">Discord</span>');
        if (providers.length === 0) providers.push('<span class="provider-badge disabled">No providers configured</span>');

        document.getElementById('alert-providers').innerHTML = providers.join('');

        if (alerts.recent && alerts.recent.length > 0) {
          document.getElementById('alert-history').innerHTML = alerts.recent.slice().reverse().map(function(a) {
            return '<div class="alert-item">' +
              '<div class="alert-type">' + a.type + '</div>' +
              '<div class="alert-message">' + a.message + '</div>' +
              '<div class="alert-time">' + new Date(a.timestamp).toLocaleString() + '</div>' +
            '</div>';
          }).join('');
        } else {
          document.getElementById('alert-history').innerHTML = '<div class="empty-state">No alerts yet</div>';
        }
      }
    }

    function toggleErrors() {
      const el = document.getElementById('recent-errors');
      el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }

    async function poll() {
      try {
        const res = await fetch(API);
        if (!res.ok) throw new Error('bad response');
        const data = await res.json();
        update(data);
      } catch {}
    }

    poll();
    setInterval(poll, 2000);
  </script>
</body>
</html>
