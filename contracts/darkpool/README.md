# CREDarkPool Integration Guide

Chainlink Confidential Compute Private Transactions integration for the Self-Healing Reserve dark pool.

## Overview

This integration enables **confidential collateral recovery** where:
- Recovery need is encrypted (amount hidden)
- Market makers fill via private transactions to shielded addresses
- No on-chain visibility of participants or amounts until withdrawal
- Cryptographic tickets prevent front-running and ensure settlement

## Architecture

```
┌─────────────────────────────────────────────────────────────────────┐
│                    CONFIDENTIAL DARK POOL FLOW                      │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  1. REQUEST                                                         │
│     Recovery Agent → DarkPool.requestCollateral()                   │
│     - Encrypted amount (TEE public key)                             │
│     - Shielded address (one-time use)                               │
│     - Premium incentive + timeout                                   │
│                                                                     │
│  2. FILL (Off-Chain)                                                │
│     Market Maker → Vault Contract → Shielded Address                │
│     - Deposit via private transaction                               │
│     - No link to MM identity                                        │
│                                                                     │
│  3. VERIFY (TEE)                                                    │
│     Chainlink CC → confidentialFill()                               │
│     - Verify deposit to shielded address                            │
│     - Generate withdrawal ticket                                    │
│     - ZK proof of valid matching                                    │
│                                                                     │
│  4. WITHDRAW                                                        │
│     Recovery Agent → withdrawWithTicket()                           │
│     - Submit cryptographic ticket                                   │
│     - Amount revealed ONLY here                                     │
│     - Funds transferred to agent                                    │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

## Files

### Smart Contracts
- `CREDarkPool.sol` - Main dark pool contract with private transaction support

### Integration Scripts
- `DarkPoolPrivateTransactions.ts` - TypeScript SDK for the complete flow

### Research
- `confidential-http-workshop.md` - Workshop notes on Confidential HTTP
- `chainlink-private-transactions-workshop.md` - Private transactions workshop transcript

## Key Features

### 1. Encrypted Amounts
Amounts are encrypted with the TEE public key and never stored on-chain:
```solidity
bytes32 encryptedAmount;  // Only TEE can decrypt
```

### 2. Shielded Addresses
One-time addresses that cannot be linked to real addresses:
```solidity
bytes32 shieldedAddress;  // Generated by TEE, looks like normal address
```

### 3. Withdrawal Tickets
Cryptographic proofs from the TEE that prevent:
- Double-spending
- Front-running
- Unauthorized withdrawals

### 4. Privacy Guarantees
| Information | Visibility |
|-------------|------------|
| Request amount | Encrypted (TEE only) |
| Market maker identity | Hidden until withdrawal |
| Fill amount | Encrypted (TEE only) |
| Shielded address | Public (but unlinkable) |
| Final amount | Revealed at withdrawal only |

## Usage

### Creating a Recovery Request

```typescript
import { DarkPoolPrivateTxManager } from './DarkPoolPrivateTransactions';

const manager = new DarkPoolPrivateTxManager(provider, signer);

// 1. Generate shielded address
const shieldedAddress = await manager.generateShieldedAddress();

// 2. Create request
const requestId = await manager.createRequest(
  '10000',      // $10,000
  200,          // 2% premium
  3600,         // 1 hour timeout
  shieldedAddress
);
```

### Market Maker Fill

```typescript
// Market maker deposits to shielded address (off-chain via Vault)
// TEE verifies and generates ticket

await manager.submitConfidentialFill(
  requestId,
  encryptedAmount,
  shieldedAddress,
  teeAttestation,
  withdrawalTicket
);
```

### Withdrawal

```typescript
// Recovery agent withdraws using ticket
await manager.withdrawWithTicket(
  requestId,
  tokenAddress,
  amount,
  withdrawalTicket
);
```

## Integration with Self-Healing Reserve

The dark pool is called by the `RecoveryAgent` when:
1. Reserve is undercollateralized
2. Deficit exceeds $10K (threshold for dark pool vs. direct wallet)
3. Privacy is critical (avoid market signaling)

```solidity
// In RecoveryAgent.sol
if (deficit > DARK_POOL_THRESHOLD) {
    // Use confidential dark pool
    darkPool.requestCollateral(
        encryptedDeficit,
        premiumBps,
        timeout,
        shieldedAddress
    );
} else {
    // Use direct wallet for small amounts
    executeDirectRecovery(deficit);
}
```

## API Authentication

All calls to Chainlink CC APIs require EIP-712 signatures:

```typescript
const signature = await manager.generateApiSignature(
  tokenAddress,
  shieldedAddress
);

// Use signature in API call headers
const response = await fetch(`${CC_API}/privateTokenTransfer`, {
  headers: {
    'X-Signature': signature
  }
});
```

## Deployment

### Prerequisites
1. Deploy `CREDarkPool.sol`
2. Set Vault contract address (Chainlink CC)
3. Set Policy Engine address (ACE compliance)
4. Grant TEE_VERIFIER_ROLE to Chainlink CRE oracle

### Configuration
```bash
export DARK_POOL_ADDRESS=0x...
export VAULT_ADDRESS=0x...
export TEE_PUBLIC_KEY=0x...
export CC_API_URL=https://api.chainlink.confidential/v1
```

## Testing

Run the example flow:
```bash
cd contracts/darkpool
npx ts-node DarkPoolPrivateTransactions.ts
```

## Security Considerations

1. **Encryption**: Use proper encryption (RSA/ECIES) with TEE public key
2. **Replay Protection**: Tickets are one-time use
3. **Expiration**: Requests timeout to prevent stale orders
4. **Compliance**: ACE policy engine enforces regulatory rules

## Next Steps

1. Deploy contracts to Sepolia
2. Test integration with Chainlink CC sandbox
3. Implement proper encryption for amounts
4. Add ZK proof verification
5. Create monitoring dashboard

## References

- [Chainlink Confidential Compute Docs](https://chain.link/confidential)
- [Private Transactions Sandbox](https://confidential.chain.link)
- [EIP-712 Standard](https://eips.ethereum.org/EIPS/eip-712)
